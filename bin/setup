#!/usr/bin/bash

echo "Updating the system..."
sudo apt update
sudo apt full-upgrade

if ! dpkg -l | grep -q unattended-upgrades; then
  echo "Installing unattended-upgrades..."
  sudo apt install -y unattended-upgrades
fi

if ! [ -f .env ]; then
  echo "Creating .env file..."
  echo "SIGNALK_VERSION=latest" > .env
  echo "INFLUXDB2_TOKEN=$(openssl rand -base64 20)" >> .env
fi

if [ -x "$(command -v docker)" ]; then
  echo "Docker is already installed."
else
  echo "Installing Docker..."
  curl -sSL https://get.docker.com | sh

  # Add docker group
  sudo groupadd docker || true
  # Add the current user to the docker group
  sudo usermod -aG docker $USER
  # Activate the new group
  newgrp docker

  # Start the Docker service
  sudo service docker start
fi

if ! grep -q signalk-to-influxdb2 ~/.signalk/package.json; then
  echo "Installing signalk-to-influxdb2..."
  docker compose down signalk
  docker compose up -d influxdb
  docker compose run --rm -v ${PWD}:/src --entrypoint bash signalk -c "npm signalk install signalk-to-influxdb2 && \
    cp /src/plugin-config-data/signalk-to-influxdb2.json plugin-config-data"
fi

docker compose up -d
